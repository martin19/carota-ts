<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.22/require.min.js"></script>
  <style>
    #exampleEditor {
      border: 1px solid silver;
      position: absolute;
      left: 10px;
      top: 40px;
      right: 50%;
      bottom: 40px;
    }

    #exampleCanvas {
      position: absolute;
      left: 0;
      top: 0;
      width: 800px;
      height: 800px;
      background-color: wheat;
    }

    #examplePersistence {
      position: absolute;
      top: 40px;
      width: 50%;
      right: 0;
      bottom: 40px;
    }

    #examplePersistence div {
      position: absolute;
      left: 10px;
      top: 0;
      right: 10px;
      bottom: 0;
      overflow: hidden;
    }

    #examplePersistence textarea {
      width: 99%;
      height: 99%;
      border: none;
      background: rgb(30, 30, 30);
      color: rgb(0, 200, 20);
    }

    button img {
      width: 12px;
      height: 12px;
    }

    .editablePage {
      display: none
    }
  </style>
</head>
<body>


<div id="exampleEditor">
  <canvas id="exampleCanvas" width="800" height="800"></canvas>
</div>

<div id="examplePersistence">
  <div>
    <textarea></textarea>
  </div>
</div>

<div class="editablePage" id="welcome">
  <h1>Welcome!</h1>
  <br>
  <p>You've found the demo page for <span class="carota">Carota</span>, a rich text editor
    implemented entirely in JavaScript that uses HTML5 Canvas for rendering. Most in-browser
    editors use a built-in feature called <code>contentEditable</code> to do most of the
    hard work, but this has some limitations and drawbacks that are just too much for more
    sensitive people, like me, to bear, so I decided to start from scratch.
    (Anyway, it's fun to write your own editor!)
  </p>
  <br>
  <p>The source code is released under the very permissive <strong>MIT license</strong>,
    so you can do pretty much anything you want with it.
  </p>
  <br>
  <p>At runtime Carota has <em>no external dependencies</em>. You just pull in the
    carota-min.js file using the SCRIPT tag and away you go. Or else get node and use:
  </p>
  <br>
  <p>
    <code>npm install carota</code>
  </p>
  <br>
  <p>to get the full source, including this demo site. By the way,
    <span class="carota">Carota</span> itself is displaying all this text, meaning that
    you can play with the editor right now! Try <code>Ctrl+A</code> and then
    <code>Backspace</code> to clear this document and see how the JSON view on the right
    changes as you make further edits. Press <code>Ctrl+Z</code> to undo your changes.
  </p>
  <br>
  <p><strong>Click the links below for more information...</strong>
  <p>
  </p>
</div>

<script>
  window.onload = function () {
    require.config({
      baseUrl: './src'
    });
    require(["carota"], function (carota) {
      carota = carota.carota;

      var canvas = document.querySelector("#exampleCanvas");
      var editor = new carota.Editor({
        canvas: canvas,
        x : 400,
        y : 400,
        w : 400,
        h : 500
      });
      var exampleEditor = editor.getDoc();

      window.editor = editor;

      // We don't update the JSON view until half a second after the last change
      // to avoid slowing things down too much
      var persistenceTextArea = document.querySelector('#examplePersistence textarea');
      var updateTimer = null;
      var updatePersistenceView = function () {
        if (updateTimer !== null) {
          clearTimeout(updateTimer);
        }
        updateTimer = setTimeout(function () {
          updateTimer = null;
          persistenceTextArea.value = JSON.stringify(exampleEditor.save(), null, 4);
        }, 500);
      };

      var manuallyChangingJson = 0;
      carota.Dom.handleEvent(persistenceTextArea, 'input', function () {
        try {
          manuallyChangingJson++;
          exampleEditor.load(JSON.parse(persistenceTextArea.value), false);
        } catch (x) {
          // ignore if syntax errors
        } finally {
          manuallyChangingJson--;
        }
      });

      // Whenever the document changes, re-display the JSON format and update undo buttons
      exampleEditor.contentChanged.on(function () {
        TextBoxController.updateUndo();
        if (!manuallyChangingJson) {
          updatePersistenceView();
        }
      });

      // Load one of the hidden chunks of HTML
      var load = function (selector) {
        var html = document.querySelector(selector);
        if (html) {
          var paragraphs = carota.Html.parse(html, {
            carota: {color: 'orange', bold: true, size: 14}
          });
          exampleEditor.load(paragraphs);

          console.log(JSON.stringify(carota.EngineDataExport.save(exampleEditor),2," "));
        }
      };

      var load = function() {
        $.getJSON("./src/importexport/enginedata_area.json", function(engineData) {
        //$.getJSON("./src/import/enginedata_paragraphs.json", function(engineData) {
          var runs = carota.EngineDataImport.parse(engineData);
          exampleEditor.load(runs);

            console.log(JSON.stringify(carota.EngineDataExport.save(exampleEditor),2," "));
        });
      };

      //dat.gui
      var TextBoxController = {
        init() {
          var textBoxOptions = {
            font: "serif",
            size: 8,
            baselineShift : 0,
            lineHeight : 0,
            letterSpacing : 0.1,
            verticalScaling : 1.0,
            horizontalScaling : 1.0,
            bold: false,
            italic: false,
            underline: false,
            strikeout: false,
            script: "normal",
            capitals: false,
            color: "black",
            undo: function () {
              exampleEditor.performUndo(false);
            },
            redo: function () {
              exampleEditor.performUndo(true);
            },
            wrap : true,
            origin : "center",
            baselines : false,
          };

          var gui = new dat.GUI({hideable:false});

          var f1 = gui.addFolder("Character");
          var cFormatting = [];
          cFormatting.push(f1.add(textBoxOptions, "font", ["serif", "sans-serif", "monospace", "cursive", "fantasy"]).listen());
          cFormatting.push(f1.add(textBoxOptions, "size", [8, 9, 10, 11, 12, 14, 16, 18, 20, 24, 30, 36, 72]).listen());
          cFormatting.push(f1.add(textBoxOptions, "baselineShift").min(-50).max(50).listen());
          cFormatting.push(f1.add(textBoxOptions, "letterSpacing").min(-0.2).max(0.2).listen());
          cFormatting.push(f1.add(textBoxOptions, "verticalScaling").min(0).max(10).listen());
          cFormatting.push(f1.add(textBoxOptions, "horizontalScaling").min(0).max(10).listen());
          cFormatting.push(f1.add(textBoxOptions, "lineHeight").min(0).max(100).listen());
          cFormatting.push(f1.add(textBoxOptions, "bold").listen());
          cFormatting.push(f1.add(textBoxOptions, "italic").listen());
          cFormatting.push(f1.add(textBoxOptions, "underline").listen());
          cFormatting.push(f1.add(textBoxOptions, "strikeout").listen());
          cFormatting.push(f1.add(textBoxOptions, "script", ["normal", "super", "sub"]).listen());
          cFormatting.push(f1.add(textBoxOptions, "capitals").listen());
          cFormatting.push(f1.add(textBoxOptions, "color", ["black", "red", "green", "blue", "orange"]).listen());

          var cOrigin = f1.add(textBoxOptions, "origin", ["topleft","center","bottomright"]);
          var cWrap = f1.add(textBoxOptions, "wrap");
          var cBaselines = f1.add(textBoxOptions,"baselines");

          cFormatting.forEach(function (c) {
            c.onChange(function (value) {
              var range = exampleEditor.selectedRange();
              range.setCharacterFormatting(this.property, value);
            });
          });
          cWrap.onChange(function(value) {
            exampleEditor.setWrap(value);
          });
          cOrigin.onChange(function(value) {
            switch(value) {
              case "topleft" : editor.setOrigin(-0.5,-0.5); break;
              case "center" : editor.setOrigin(0,0); break;
              case "bottomright" : editor.setOrigin(0.5,0.5); break;
            }
          });
          cBaselines.onChange(function(value) { editor.setPaintBaselines(value); });

          var paragraphOptions = {
            align: "left",
            marginLeft : 0,
            marginRight : 0,
            spaceBefore : 0,
            spaceAfter : 0,
            hyphenate : false
          };

          var f2 = gui.addFolder("Paragraph");
          var cParagraph = [];
          var optionAlign = f2.add(paragraphOptions, "align", ["left","center","right","justifyLastLeft","justifyLastCentered","justifyLastRight","justifyAll"]);
          cParagraph.push(optionAlign.listen());
          cParagraph.push(f2.add(paragraphOptions,"marginLeft").min(-50).max(50).listen());
          cParagraph.push(f2.add(paragraphOptions,"marginRight").min(-50).max(50).listen());
          cParagraph.push(f2.add(paragraphOptions,"spaceBefore").min(-50).max(50).listen());
          cParagraph.push(f2.add(paragraphOptions,"spaceAfter").min(-50).max(50).listen());
          cParagraph.push(f2.add(paragraphOptions,"hyphenate").listen());

          cParagraph.forEach(function(c){
            c.onChange(function(value){
              var range = exampleEditor.selectedRange();
              range.setParagraphFormatting(this.property, value);
            });
          });

          var f3 = gui.addFolder("Undo/Redo");
          f3.add(textBoxOptions, "undo");
          f3.add(textBoxOptions, "redo");

          // When the selected range coordinates change, update the control
          exampleEditor.selectionChanged.on(function (data) {
            //set CharacterFormatting UI
            cFormatting.forEach(function(c){
              var id = c.property;
              var formatting = data.getFormatting();
              var val = id in formatting ? formatting[id] : carota.Run.defaultFormatting[id];
              if(val === carota.Run.multipleValues) {
                //indeterminate
              }
              textBoxOptions[id] = val;
            });
            //set ParagraphFormatting UI
            cParagraph.forEach(function(c){
              var id=c.property;
              var range = exampleEditor.selectedRange();
              var formatting = range.getParagraphFormatting();
              var val = id in formatting ? formatting[id] : carota.Paragraph.defaultFormatting[id];
              if(val === carota.Paragraph.multipleValues) {
                //indeterminate
              }
              paragraphOptions[id] = val;
            });
          });

          var textBoxPosition = {
            cx : 100,
            cy : 100,
            alpha : 0,
            skewX : 0,
            skewY : 0,
            w : 100,
            h : 100,
            sx : 1.0,
            sy : 1.0
          };

          var gui2 = new dat.GUI({hideable : false});
          var f4 = gui2.addFolder("Position");
          var cCx = f4.add(textBoxPosition,"cx").min(0).max(500);
          var cCy = f4.add(textBoxPosition,"cy").min(0).max(500);
          var cAlpha = f4.add(textBoxPosition,"alpha").min(0).max(Math.PI*2);
          var cSkewX = f4.add(textBoxPosition,"skewX").min(0).max(Math.PI/2);
          var cSkewY = f4.add(textBoxPosition,"skewY").min(0).max(Math.PI/2);
          var cW = f4.add(textBoxPosition,"w").min(0).max(500);
          var cH = f4.add(textBoxPosition,"h").min(0).max(500);
          var cSx = f4.add(textBoxPosition,"sx").min(-5).max(5);
          var cSy = f4.add(textBoxPosition,"sy").min(-5).max(5);

          cCx.onChange(function(value){
            editor.setPosition(value, editor.getPosition().y);
          });
          cCy.onChange(function(value){
            editor.setPosition(editor.getPosition().x, value);
          });
          cAlpha.onChange(function(value){
            editor.setRotation(value)
          });
          cSkewX.onChange(function(value){
            editor.setSkew(value, editor.getSkew().skewY);
          });
          cSkewY.onChange(function(value){
            editor.setSkew(editor.getSkew().skewX, value);
          });
          cW.onChange(function(value){
            editor.setSize(value, editor.getSize().h);
          });
          cH.onChange(function(value){
            editor.setSize(editor.getSize().w, value);
          });
          cSx.onChange(function(value){
            editor.setScale(value, editor.getScale().y);
          });
          cSy.onChange(function(value){
            editor.setScale(editor.getScale().x, value);
          });

          f1.open();
          f2.open();
          //f4.open();
        },
        updateUndo: function () {
          //undo.disabled = !exampleEditor.canUndo(false);
          //redo.disabled = !exampleEditor.canUndo(true);
        }
      };
      TextBoxController.init();

      load('#welcome');
    });
  };
</script>
</body>
</html>
